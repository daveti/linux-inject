#
# upatch specifics
#
# based on:
# httpd-2.4.6-45.el7.src.rpm

UPATCH=cve_2015_3185
TRAMPOLINES := \
	/usr/sbin/httpd	ap_process_request_internal

PATCH_SRC=patches.c

patches.o: patches.c
	/usr/lib64/apr-1/build/libtool \
	--silent \
	--mode=compile \
	gcc \
	-std=gnu99 \
	-pthread \
	-O2 \
	-g \
	-pipe \
	-Wall \
	-Wp,-D_FORTIFY_SOURCE=2 \
	-fexceptions \
	-fstack-protector-strong \
	--param=ssp-buffer-size=4 \
	-grecord-gcc-switches \
	-m64 \
	-mtune=generic \
	-DLINUX \
	-D_REENTRANT \
	-D_GNU_SOURCE \
	-I/root/rpmbuild/BUILD/httpd-2.4.6 \
	-I/root/rpmbuild/BUILD/httpd-2.4.6/os/unix \
	-I/root/rpmbuild/BUILD/httpd-2.4.6/include \
	-I/usr/include/apr-1 \
	-I/root/rpmbuild/BUILD/httpd-2.4.6/modules/aaa \
	-I/root/rpmbuild/BUILD/httpd-2.4.6/modules/cache \
	-I/root/rpmbuild/BUILD/httpd-2.4.6/modules/core \
	-I/root/rpmbuild/BUILD/httpd-2.4.6/modules/database \
	-I/root/rpmbuild/BUILD/httpd-2.4.6/modules/filters \
	-I/root/rpmbuild/BUILD/httpd-2.4.6/modules/ldap \
	-I/root/rpmbuild/BUILD/httpd-2.4.6/server \
	-I/root/rpmbuild/BUILD/httpd-2.4.6/modules/loggers \
	-I/root/rpmbuild/BUILD/httpd-2.4.6/modules/lua \
	-I/root/rpmbuild/BUILD/httpd-2.4.6/modules/proxy \
	-I/root/rpmbuild/BUILD/httpd-2.4.6/modules/session \
	-I/root/rpmbuild/BUILD/httpd-2.4.6/modules/ssl \
	-I/root/rpmbuild/BUILD/httpd-2.4.6/modules/test \
	-I/root/rpmbuild/BUILD/httpd-2.4.6/server \
	-I/root/rpmbuild/BUILD/httpd-2.4.6/modules/arch/unix \
	-I/root/rpmbuild/BUILD/httpd-2.4.6/modules/dav/main \
	-I/root/rpmbuild/BUILD/httpd-2.4.6/modules/generators \
	-I/root/rpmbuild/BUILD/httpd-2.4.6/modules/mappers \
	-fPIC \
	-c \
	$^ \

#	-fPIE \
#	-prefer-non-pic \
#	-static \

#
# upatch boilerplate
#

.DEFAULT_GOAL:=all
all: libupatch_$(UPATCH).so

CFLAGS=-fPIC -Wall -ggdb -MP -MD

libupatch_$(UPATCH).so: $(PATCH_SRC:.c=.o) trampolines.o
	$(CC) -shared -lupatch -lsystemd -Wl,-soname,$@ -o $@ $^

-include trampolines.d

trampolines.c:
	../gen_trampolines ${TRAMPOLINES} > $@

install: all
	install -D libupatch_$(UPATCH).so /usr/lib64
	ldconfig -n /usr/lib64

uninstall:
	$(RM) /usr/lib64/libupatch_$(UPATCH).so
	ldconfig -n /usr/lib64

clean:
	$(RM) -f trampolines.c *.d *.o *.so *.lo

.PHONY: install uninstall clean
