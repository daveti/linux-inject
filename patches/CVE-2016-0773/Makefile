#
# upatch specifics
#
# based on postgresql-9.2.14-1.el7_1

UPATCH=cve_2016_0773
TRAMPOLINES := \
	/usr/bin/postgres dovec \
	/usr/bin/postgres lexescape \
	/usr/bin/postgres range \

PRIV_FUNCS := \
	/usr/bin/postgres chr chrnamed \
	/usr/bin/postgres "struct cvec *" getcvec \
	/usr/bin/postgres chr lexdigits \
	/usr/bin/postgres void newarc \
	/usr/bin/postgres color newsub \
	/usr/bin/postgres int pg_wc_isalnum \
	/usr/bin/postgres pg_wchar pg_wc_tolower \
	/usr/bin/postgres pg_wchar pg_wc_toupper \
	/usr/bin/postgres color subcolor \

PATCH_SRC=patches.c

patches.o: patches.c upatch_private.h
	$(CC) \
		-fPIC \
		-O2 \
		-g \
		-pipe \
		-Wall \
		-Wp,-D_FORTIFY_SOURCE=2 \
		-fexceptions \
		-fstack-protector-strong \
		--param=ssp-buffer-size=4 \
		-grecord-gcc-switches \
		-m64 \
		-mtune=generic \
		-DLINUX_OOM_SCORE_ADJ=0 \
		-Wall \
		-Wmissing-prototypes \
		-Wpointer-arith \
		-Wdeclaration-after-statement \
		-Wendif-labels \
		-Wmissing-format-attribute \
		-Wformat-security \
		-fno-strict-aliasing \
		-fwrapv \
		-fexcess-precision=standard \
		-I/root/rpmbuild/BUILD/postgresql-9.2.14/src/include \
		-D_GNU_SOURCE \
		-I/usr/include/libxml2 \
		-c \
		-o \
		patches.o \
		patches.c

#
# upatch boilerplate
#

.DEFAULT_GOAL:=all
all: libupatch_$(UPATCH).so

CFLAGS=-fPIC -Wall -ggdb -MP -MD

libupatch_$(UPATCH).so: $(PATCH_SRC:.c=.o) trampolines.o
	$(CC) -shared -lupatch -lsystemd -Wl,-soname,$@ -o $@ $^

-include trampolines.d

trampolines.c:
	../gen_trampolines ${TRAMPOLINES} > $@

upatch_private.h:
	../gen_priv_funcs ${PRIV_FUNCS} > $@

install: all
	install -D libupatch_$(UPATCH).so /usr/lib64
	ldconfig -n /usr/lib64

uninstall:
	$(RM) /usr/lib64/libupatch_$(UPATCH).so
	ldconfig -n /usr/lib64

clean:
	$(RM) -f trampolines.c upatch_private.h *.d *.o *.so

.PHONY: install uninstall clean
