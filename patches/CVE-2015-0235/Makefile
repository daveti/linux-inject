#
# upatch specifics
#

UPATCH=cve_2015_0235
TRAMPOLINES := \
	/usr/lib64/libc.so.6 __nss_hostname_digits_dots

PATCH_SRC=patches.c

patches.o: patches.c
	$(CC) \
	$< \
	-fPIC \
	-c \
	-std=gnu99 \
	-fgnu89-inline \
	-DNDEBUG \
	-O3 \
	-Wall \
	-Winline \
	-Wwrite-strings \
	-fasynchronous-unwind-tables \
	-fmerge-all-constants \
	-frounding-math \
	-g \
	-mtune=generic \
	-Wstrict-prototypes \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/include \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/build-x86_64-redhat-linux/nss \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/build-x86_64-redhat-linux \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/sysdeps/unix/sysv/linux/x86_64/64/nptl \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/sysdeps/unix/sysv/linux/x86_64/64 \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/nptl/sysdeps/unix/sysv/linux/x86_64 \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/nptl/sysdeps/unix/sysv/linux/x86 \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/sysdeps/unix/sysv/linux/x86 \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/rtkaio/sysdeps/unix/sysv/linux/x86_64 \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/sysdeps/unix/sysv/linux/x86_64 \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/sysdeps/unix/sysv/linux/wordsize-64 \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/ports/sysdeps/unix/sysv/linux \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/nptl/sysdeps/unix/sysv/linux \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/nptl/sysdeps/pthread \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/rtkaio/sysdeps/pthread \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/sysdeps/pthread \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/rtkaio/sysdeps/unix/sysv/linux \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/sysdeps/unix/sysv/linux \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/sysdeps/gnu \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/sysdeps/unix/inet \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/ports/sysdeps/unix/sysv \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/nptl/sysdeps/unix/sysv \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/rtkaio/sysdeps/unix/sysv \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/sysdeps/unix/sysv \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/sysdeps/unix/x86_64 \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/ports/sysdeps/unix \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/nptl/sysdeps/unix \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/rtkaio/sysdeps/unix \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/sysdeps/unix \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/sysdeps/posix \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/nptl/sysdeps/x86_64/64 \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/sysdeps/x86_64/64 \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/sysdeps/x86_64/fpu/multiarch \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/sysdeps/x86_64/fpu \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/sysdeps/x86/fpu \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/sysdeps/x86_64/multiarch \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/nptl/sysdeps/x86_64 \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/sysdeps/x86_64 \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/sysdeps/x86 \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/sysdeps/ieee754/ldbl-96 \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/sysdeps/ieee754/dbl-64/wordsize-64 \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/sysdeps/ieee754/dbl-64 \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/sysdeps/ieee754/flt-32 \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/sysdeps/wordsize-64 \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/sysdeps/ieee754 \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/sysdeps/generic \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/ports \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/nptl \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/rtkaio \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686 \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/libio \
	-I/root/rpmbuild/BUILD/glibc-2.17-c758a686/nss \
	-nostdinc \
	-isystem \
	/usr/lib/gcc/x86_64-redhat-linux/4.8.5/include \
	-isystem \
	/usr/include \
	-D_LIBC_REENTRANT \
	-include \
	/root/rpmbuild/BUILD/glibc-2.17-c758a686/build-x86_64-redhat-linux/libc-modules.h \
	-include \
	/root/rpmbuild/BUILD/glibc-2.17-c758a686/include/libc-symbols.h \
	-o \
	$@


#
# upatch boilerplate
#

.DEFAULT_GOAL:=all
all: libupatch_$(UPATCH).so

CFLAGS=-fPIC -Wall -ggdb -MP -MD

libupatch_$(UPATCH).so: $(PATCH_SRC:.c=.o) trampolines.o
	$(CC) -shared -lupatch -lsystemd -Wl,-soname,$@ -o $@ $^

-include trampolines.d

trampolines.c:
	../gen_trampolines ${TRAMPOLINES} > $@

install: all
	install -D libupatch_$(UPATCH).so /usr/lib64
	ldconfig -n /usr/lib64

uninstall:
	$(RM) /usr/lib64/libupatch_$(UPATCH).so
	ldconfig -n /usr/lib64

clean:
	$(RM) -f trampolines.c *.d *.o *.so

.PHONY: install uninstall clean

