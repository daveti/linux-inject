#
# upatch specifics
#

UPATCH=cve_2015_0240
TRAMPOLINES := \
	/usr/lib64/samba/libsmbd_base.so netr_creds_server_step_check \
	/usr/lib64/samba/libsmbd_base.so _netr_ServerPasswordSet

PATCH_SRC=patches.c

patches.o: patches.c
	gcc \
	-g \
	-pipe \
	-Wall \
	-fexceptions \
	-fstack-protector-strong \
	--param=ssp-buffer-size=4 \
	-grecord-gcc-switches \
	-m64 \
	-mtune=generic \
	-fPIC \
	-fstack-protector \
	-D_REENTRANT \
	-D_POSIX_PTHREAD_SEMANTICS \
	-DSTATIC_RPC_NETLOGON_MODULES=NULL \
	-DSTATIC_RPC_NETLOGON_MODULES_PROTO= \
	-MD \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/source3/rpc_server \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../source3/rpc_server \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/source3 \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../source3 \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/source3/include \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../source3/include \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/source3/lib \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../source3/lib \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/lib/tdb_compat \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../lib/tdb_compat \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/include/public \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../include/public \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/source4 \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../source4 \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/lib \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../lib \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/source4/lib \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../source4/lib \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/source4/include \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../source4/include \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/include \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../include \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/lib/replace \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../lib/replace \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/.. \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/lib/param \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../lib/param \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/libcli/lsarpc \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../libcli/lsarpc \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/libcli/ldap \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../libcli/ldap \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/source3/auth \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../source3/auth \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/librpc \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../librpc \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/libcli/nbt \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../libcli/nbt \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/source4/dsdb \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../source4/dsdb \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/libcli/auth \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../libcli/auth \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/source4/librpc \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../source4/librpc \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/lib/addns \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../lib/addns \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/auth/gensec \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../auth/gensec \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/auth/credentials \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../auth/credentials \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/lib/krb5_wrap \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../lib/krb5_wrap \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/lib/ntdb \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../lib/ntdb \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/libcli/dns \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../libcli/dns \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/source4/lib/socket \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../source4/lib/socket \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/libcli/registry \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../libcli/registry \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/lib/ccan \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../lib/ccan \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/libcli/util \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../libcli/util \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/source4/auth/kerberos \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../source4/auth/kerberos \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/source4/param \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../source4/param \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/lib/socket \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../lib/socket \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/lib/util/charset \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../lib/util/charset \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/source4/lib/events \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../source4/lib/events \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/source3/librpc \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../source3/librpc \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/lib/async_req \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../lib/async_req \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/source4/auth/gensec \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../source4/auth/gensec \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/lib/ldb-samba \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../lib/ldb-samba \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/nsswitch/libwbclient \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../nsswitch/libwbclient \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/libds/common \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../libds/common \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/auth/kerberos \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../auth/kerberos \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/source4/auth \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../source4/auth \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/lib/dbwrap \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../lib/dbwrap \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/source3/lib/pthreadpool \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../source3/lib/pthreadpool \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/libcli/netlogon \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../libcli/netlogon \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/libcli/security \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../libcli/security \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/lib/smbconf \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../lib/smbconf \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/nsswitch \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../nsswitch \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/libcli/drsuapi \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../libcli/drsuapi \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/lib/tsocket \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../lib/tsocket \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/source4/lib/tls \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../source4/lib/tls \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/auth/ntlmssp \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../auth/ntlmssp \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/auth \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../auth \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/libcli/cldap \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../libcli/cldap \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/source4/libcli \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../source4/libcli \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/libcli/smb \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../libcli/smb \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/libcli/named_pipe_auth \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../libcli/named_pipe_auth \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/source4/libcli/ldap \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../source4/libcli/ldap \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/dynconfig \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../dynconfig \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/source3/param \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../source3/param \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/lib/compression \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../lib/compression \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/source4/lib/stream \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../source4/lib/stream \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/default/lib/crypto \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin/../lib/crypto \
	-I/root/rpmbuild/BUILD/samba-4.1.12/bin//usr/local/include \
	-D_SAMBA_BUILD_=4 \
	-DHAVE_CONFIG_H=1 \
	-D_GNU_SOURCE=1 \
	-D_XOPEN_SOURCE_EXTENDED=1 \
	patches.c \
	-c \
	-o \
	patches.o

#
# upatch boilerplate
#

.DEFAULT_GOAL:=all
all: libupatch_$(UPATCH).so

CFLAGS=-fPIC -Wall -ggdb -MP -MD

libupatch_$(UPATCH).so: $(PATCH_SRC:.c=.o) trampolines.o
	$(CC) -shared -lupatch -lsystemd -Wl,-soname,$@ -o $@ $^

-include trampolines.d

trampolines.c:
	../gen_trampolines ${TRAMPOLINES} > $@

install: all
	install -D libupatch_$(UPATCH).so /usr/lib64
	ldconfig -n /usr/lib64

uninstall:
	$(RM) /usr/lib64/libupatch_$(UPATCH).so
	ldconfig -n /usr/lib64

clean:
	$(RM) -f trampolines.c *.d *.o *.so

.PHONY: install uninstall clean
