#
# upatch specifics
#

UPATCH=cve_2015_5477
TRAMPOLINES := \
	/usr/lib64/libdns.so.100 dns_tkey_processquery

PATCH_SRC=patches.c

patches.o: patches.c
	$(CC) \
	-pthread \
	-I/root/rpmbuild/BUILD/bind-9.9.4 \
	-I/root/rpmbuild/BUILD/bind-9.9.4/lib/dns \
	-Iinclude \
	-I/root/rpmbuild/BUILD/bind-9.9.4/lib/dns/include \
	-I/root/rpmbuild/BUILD/bind-9.9.4/lib/isc/include \
	-I/root/rpmbuild/BUILD/bind-9.9.4/lib/isc \
	-I/root/rpmbuild/BUILD/bind-9.9.4/lib/isc/include \
	-I/root/rpmbuild/BUILD/bind-9.9.4/lib/isc/unix/include \
	-I/root/rpmbuild/BUILD/bind-9.9.4/lib/isc/pthreads/include \
	-I/root/rpmbuild/BUILD/bind-9.9.4/lib/isc/x86_32/include \
	-I/usr/include \
	-D_REENTRANT \
	-DUSE_MD5 \
	-DOPENSSL \
	-DGSSAPI \
	-DDIG_SIGCHASE \
	-D_GNU_SOURCE \
	-O2 \
	-g \
	-pipe \
	-Wall \
	-Wp,-D_FORTIFY_SOURCE=2 \
	-fexceptions \
	-fstack-protector-strong \
	--param=ssp-buffer-size=4 \
	-grecord-gcc-switches \
	-m64 \
	-mtune=generic \
	-I/usr/include \
	-I/usr/include/libxml2 \
	-W \
	-Wall \
	-Wmissing-prototypes \
	-Wcast-qual \
	-Wwrite-strings \
	-Wformat \
	-Wpointer-arith \
	-fno-strict-aliasing \
	-c \
	$< \
	-fPIC \
	-DPIC \
	-o \
	$@


#
# upatch boilerplate
#

.DEFAULT_GOAL:=all
all: libupatch_$(UPATCH).so

CFLAGS=-fPIC -Wall -ggdb -MP -MD

libupatch_$(UPATCH).so: $(PATCH_SRC:.c=.o) trampolines.o
	$(CC) -shared -lupatch -lsystemd -Wl,-soname,$@ -o $@ $^

-include trampolines.d

trampolines.c:
	../gen_trampolines ${TRAMPOLINES} > $@

install: all
	install -D libupatch_$(UPATCH).so /usr/lib64
	ldconfig -n /usr/lib64

uninstall:
	$(RM) /usr/lib64/libupatch_$(UPATCH).so
	ldconfig -n /usr/lib64

clean:
	$(RM) -f trampolines.c *.d *.o *.so

.PHONY: install uninstall clean
