#
# upatch specifics
#

UPATCH=cve_2016_5423
TRAMPOLINES := \
	/usr/bin/postgres ExecEvalCase \
	/usr/bin/postgres simplify_function \

PRIV_FUNCS := \
	/usr/bin/postgres void sql_inline_error_callback \
	/usr/bin/postgres "Node *" substitute_actual_parameters_mutator \
	/usr/bin/postgres "Node *" eval_const_expressions_mutator \
	/usr/bin/postgres "List *" expand_function_arguments \

PATCH_SRC=patches.c

patches.o: patches.c upatch_private.h
	$(CC) \
		-fPIC \
		-O2 \
		-g \
		-pipe \
		-Wall \
		-Wp,-D_FORTIFY_SOURCE=2 \
		-fexceptions \
		-fstack-protector-strong \
		--param=ssp-buffer-size=4 \
		-grecord-gcc-switches \
		-m64 \
		-mtune=generic \
		-DLINUX_OOM_SCORE_ADJ=0 \
		-Wall \
		-Wmissing-prototypes \
		-Wpointer-arith \
		-Wdeclaration-after-statement \
		-Wendif-labels \
		-Wmissing-format-attribute \
		-Wformat-security \
		-fno-strict-aliasing \
		-fwrapv \
		-fexcess-precision=standard \
		-I/root/rpmbuild/BUILD/postgresql-9.2.14/src/include \
		-D_GNU_SOURCE \
		-I/usr/include/libxml2 \
		-c \
		-o \
		patches.o \
		patches.c

#
# upatch boilerplate
#

.DEFAULT_GOAL:=all
all: libupatch_$(UPATCH).so

CFLAGS=-fPIC -Wall -ggdb -MP -MD

libupatch_$(UPATCH).so: $(PATCH_SRC:.c=.o) trampolines.o
	$(CC) -shared -lupatch -lsystemd -Wl,-soname,$@ -o $@ $^

-include trampolines.d

trampolines.c:
	../gen_trampolines ${TRAMPOLINES} > $@

upatch_private.h:
	../gen_priv_funcs ${PRIV_FUNCS} > $@

install: all
	install -D libupatch_$(UPATCH).so /usr/lib64
	ldconfig -n /usr/lib64

uninstall:
	$(RM) /usr/lib64/libupatch_$(UPATCH).so
	ldconfig -n /usr/lib64

clean:
	$(RM) -f trampolines.c upatch_private.h *.d *.o *.so

.PHONY: install uninstall clean
