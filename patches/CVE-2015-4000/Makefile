#
# upatch specifics
#
# based on:
# openssl-1.0.1e-42.el7_1.5.src.rpm

UPATCH=cve_2015_4000
TRAMPOLINES := \
	/usr/lib64/libssl.so ssl3_check_cert_and_algorithm

PATCH_SRC=patches.c

patches.o: patches.c
	$(CC) \
	-I/root/rpmbuild/BUILD/openssl-1.0.1e/crypto \
	-I/root/rpmbuild/BUILD/openssl-1.0.1e \
	-I/root/rpmbuild/BUILD/openssl-1.0.1e/include \
	-I/root/rpmbuild/BUILD/openssl-1.0.1e/ssl \
	-I/usr/include \
	-fPIC \
	-DOPENSSL_PIC \
	-DZLIB \
	-DOPENSSL_THREADS \
	-D_REENTRANT \
	-DDSO_DLFCN \
	-DHAVE_DLFCN_H \
	-DKRB5_MIT \
	-m64 \
	-DL_ENDIAN \
	-DTERMIO \
	-Wall \
	-O2 \
	-g \
	-pipe \
	-Wall \
	-Wp,-D_FORTIFY_SOURCE=2 \
	-fexceptions \
	-fstack-protector-strong \
	--param=ssp-buffer-size=4 \
	-grecord-gcc-switches \
	-m64 \
	-mtune=generic \
	-Wa,--noexecstack \
	-DPURIFY \
	-DOPENSSL_IA32_SSE2 \
	-DOPENSSL_BN_ASM_MONT \
	-DOPENSSL_BN_ASM_MONT5 \
	-DOPENSSL_BN_ASM_GF2m \
	-DSHA1_ASM \
	-DSHA256_ASM \
	-DSHA512_ASM \
	-DMD5_ASM \
	-DAES_ASM \
	-DVPAES_ASM \
	-DBSAES_ASM \
	-DWHIRLPOOL_ASM \
	-DGHASH_ASM \
	-c \
	$< \
	-o \
	$@

#
# upatch boilerplate
#

.DEFAULT_GOAL:=all
all: libupatch_$(UPATCH).so

CFLAGS=-fPIC -Wall -ggdb -MP -MD

libupatch_$(UPATCH).so: $(PATCH_SRC:.c=.o) trampolines.o
	$(CC) -shared -lupatch -lsystemd -Wl,-soname,$@ -o $@ $^

-include trampolines.d

trampolines.c:
	../gen_trampolines ${TRAMPOLINES} > $@

install: all
	install -D libupatch_$(UPATCH).so /usr/lib64
	ldconfig -n /usr/lib64

uninstall:
	$(RM) /usr/lib64/libupatch_$(UPATCH).so
	ldconfig -n /usr/lib64

clean:
	$(RM) -f trampolines.c *.d *.o *.so

.PHONY: install uninstall clean
